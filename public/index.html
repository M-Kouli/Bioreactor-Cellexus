<!-- By: Mo Kouli -->
<!-- Date: 5 March 2024  -->

<!DOCTYPE html>
<!-- Define the document type as HTML5 -->
<html lang="en">
<!-- Start of the HTML document with English language set -->

<head>
  <meta charset="UTF-8">
  <!-- Meta tag to set the character encoding for the document to UTF-8 -->
  <title>Bioreactor Controller</title>
  <!-- Title of the HTML document, appears in the browser tab -->
  <link rel="stylesheet" href="styles.css">
  <!-- Link the css file -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <!-- Link the stylesheet for the icons    -->
</head>

<body>
  <!-- Body of the document starts here -->
  <nav class="sidebar close">
    <header>
      <div class="image-text">
        <span class="image">
          <img src="logo.png" alt="logo" />
        </span>
        <div class="text header-text">
          <span class="main">KLI Bioreactor</span>
          <span class="sub">Controller</span>
        </div>
      </div>
      <i class="bx bx-chevron-right toggle"></i>
    </header>

    <div class="menu-bar">
      <div class="menu">
        <ul class="menu-links">
          <li class="nav-link">
            <a href="index.html">
              <i class="bx bx-home-alt icons"></i>
              <span class="text nav-text">Dashboard</span>
            </a>
          </li>
          <li class="nav-link">
            <a href="charts.html">
              <i class="bx bx-bar-chart-alt-2 icons"></i>
              <span class="text nav-text">Charts</span>
            </a>
          </li>
          <li class="nav-link">
            <a href="logs.html">
              <i class="bx bx-receipt icons"></i>
              <span class="text nav-text">Log Files</span>
            </a>
          </li>
          <li class="nav-link">
            <a href="logs.html">
              <i class="bx bx-cog icons"></i>
              <span class="text nav-text">Settings</span>
            </a>
          </li>
        </ul>
      </div>

      <div class="bottom-content">
        <li class="nav-link">
          <a href="#" id="logoutBtn">
            <i class="bx bx-log-out icons"></i>
            <span class="text nav-text">Log Out</span>
          </a>
        </li>
      </div>
    </div>
  </nav>
  <section class="home-section">
    <div class="top-nav">
      <div class="top-control">
        <i class="bx bx-play" id="startBtn"></i>
        <span class="stopwatch" id="stopwatch">00:00:00</span>
        <i class="bx bx-stop" id="stopBtn"></i>
      </div>
    </div>
    <div class="main-sec">
      <div class="boxes-container">
        <div class="box" id="light-toggle-box">
          <div class="speedo-desc"><i class='bx bx-cloud'></i><span>Humidity</span></div>
          <!-- <input id="speed" type="text" /> -->
          <div class="speedbox">
            <div class="speedbox__score" id="speedbox-Hum"></div>
            <div class="speedbox__score1" id="speedbox-Hum1"></div>
            <div class="speedbox__groove"></div>
            <div class="speedbox__odo">
              <div class="speedbox__ping">38<span> %</span></div>
              <hr class="speedo">
              <div class="speedbox__down"><span style="font-size: 25px;" id="humidity">14.5</span><span> %</span></div>
            </div>
            <div class="speedbox__base"><span
                style="float: left; padding: 15px; font-size: 14px; font-weight: 500;">SP/<span
                  style="color: #23576f;">RV</span></span></div>
          </div>
        </div>
        <div class="box" id="light-toggle-box">
          <div class="speedo-desc"><i class='bx bxs-thermometer'></i><span>Temperature</span></div>
          <!-- <input id="speed" type="text" /> -->
          <div class="speedbox">
            <div class="speedbox__score" id="speedbox-temp"></div>
            <div class="speedbox__score1" id="speedbox-temp1"></div>
            <div class="speedbox__groove"></div>
            <div class="speedbox__odo">
              <div class="speedbox__ping">27<span> °C</span></div>
              <hr class="speedo">
              <div class="speedbox__down"><span style="font-size: 25px;" id="temperature">32.4</span><span> °C</span>
              </div>
            </div>
            <div class="speedbox__base"><span
                style="float: left; padding: 15px; font-size: 14px; font-weight: 500;">SP/<span
                  style="color: #23576f;">RV</span></span></div>
          </div>
        </div>
        <div class="box1">
          <div class="inner-box1">
            <div class="speedo-desc"><i class='bx bx-droplet'></i><span>pH</span></div>
            <span style="font-weight: 500;"><span style="font-size: 10px;">RV </span><span
                style="color: #23576f; font-size: 20px; padding-right: 10px;" id="pH">7.00</span><span
                style="font-size: 10px;">SP</span><span style="font-size: 15px;">7.00</span></span>
            <div class="skill-main">
              <div class="skill-wrrap">
                <div class="skill-bar">
                  <div class="skill-per" id="pH-bar"></div>
                </div>
              </div>

              <div class="skill-wrrap">
                <div class="skill-bar">
                  <div class="skill-per static" id="pH-bar-static"></div>
                </div>
              </div>
            </div>
          </div>
          <hr class="speedo">
          <div class="inner-box">
            <div class="speedo-desc"><i class='bx bx-water'></i><span>Water Level</span></div>
            <span style="font-weight: 500;"><span style="font-size: 10px;">RV </span><span
                style="color: #23576f; font-size: 20px; padding-right: 10px;" id="water-level">73.0</span><span
                style="font-size: 10px;">SP</span><span style="font-size: 15px;">95.00</span></span>
            <div class="skill-main">
              <div class="skill-wrrap">
                <div class="skill-bar">
                  <div class="skill-per" id="water-level-bar"></div>
                </div>
              </div>

              <div class="skill-wrrap">
                <div class="skill-bar">
                  <div class="skill-per static" id="water-level-bar-static"></div>
                </div>
              </div>
            </div>
          </div>

        </div>
        <div class="box2">
          <div class="speedo-desc"><i class='bx bx-wind'></i><span>Gas Levels</span></div>
          <div class="gases">
            <div class="gas">CH4</div>
            <div class="gas-value" id="CH4">0.0</div>
            <div class="gas-unit">PPM</div>
          </div>
          <hr class="speedo">
          <div class="gases">
            <div class="gas">C2H5OH</div>
            <div class="gas-value" id="C2H5OH">0.0</div>
            <div class="gas-unit">PPM</div>
          </div>
          <hr class="speedo">
          <div class="gases">
            <div class="gas">H2</div>
            <div class="gas-value" id="H2">0.0</div>
            <div class="gas-unit">PPM</div>
          </div>
          <hr class="speedo">
          <div class="gases">
            <div class="gas">NH3</div>
            <div class="gas-value" id="NH3">0.0</div>
            <div class="gas-unit">PPM</div>
          </div>
          <hr class="speedo">
          <div class="gases">
            <div class="gas">CO</div>
            <div class="gas-value" id="CO">0.0</div>
            <div class="gas-unit">PPM</div>
          </div>
        </div>
        <div class="box2 box3">
          <div class="speedo-desc"><i class='bx bx-cog'></i><span>Manual Controls</span></div>
          <div class="control">
            <span>Foam Detection</span>
            <label class="switch">
              <input type="checkbox">
              <span class="slider"></span>
            </label>
          </div>
          <div class="control">
            <span>Anti-Foam Pump In</span>
            <label class="switch">
              <input type="checkbox">
              <span class="slider"></span>
            </label>
          </div>
          <div class="control">
            <span>Foam Pump Out</span>
            <label class="switch">
              <input type="checkbox">
              <span class="slider"></span>
            </label>
          </div>
          <div class="control">
            <span>Water Pump In</span>
            <label class="switch">
              <input type="checkbox">
              <span class="slider"></span>
            </label>
          </div>
          <div class="control">
            <span>Irrigation</span>
            <label class="switch">
              <input type="checkbox">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <!-- <div class="box" id="temperature-box">
          <p>Temperature</p>
          <div><span id="temperature" class="value">-</span>° Celsius</div>
        </div> -->

        <!-- <div class="box" id="humidity-box">
          <p>Humidity</p>
          <div><span id="humidity" class="value">-</span>%</div>
        </div> -->
      </div>
    </div>
  </section>
  <script src="script.js"></script>
  <script>
    // Start of the script tag for JavaScript code
    const ws = new WebSocket('ws://192.168.43.75:8080');
    // Create a new WebSocket connection to the specified server address
    // we use const because we dont want the value of ws to change

    ws.onopen = function () {
      // Function called when the WebSocket connection is established
      console.log('WebSocket connection established');
      // Log a message to the browser's console
      ws.send(JSON.stringify({ command: 'requestState' }));
    };
    // Function to handle incoming messages
    ws.onmessage = async function (event) {
      try {
        let data;
        if (event.data instanceof Blob) {
          // If the received data is a Blob, convert it to text
          const text = await event.data.text();
          data = JSON.parse(text);
        } else {
          // If it's not a Blob, assume it's already a text and parse it as JSON
          data = JSON.parse(event.data);
          updateStopwatchDisplay(data);
        }
        console.log('Parsed data:', data); // Log to see the parsed data
        try {
          // Update the webpage with the temperature and humidity
          document.getElementById('temperature').textContent = data.temperature.toFixed(2);
          document.getElementById('humidity').textContent = data.humidity.toFixed(2);
          // let updatedHum
          // speed.keyup(function () {
          //   updatedHum = Math.round(data.humidity.toFixed(2) * 180 / 100) - 45;

          //   $("#speedbox-Hum").css("transform", "rotate(" + updatedHum + "deg)");
          // });
          // let updatedtemp
          // speed.keyup(function () {
          //   updatedtemp = Math.round(data.temperature.toFixed(2) * 180 / 100) - 45;

          //   $("#speedbox-temp").css("transform", "rotate(" + updatedtemp + "deg)");
          // });
          // document.getElementById('pH').textContent = data.temperature.toFixed(2);
          // document.getElementById('water-level').textContent = data.humidity.toFixed(2);
          // document.getElementById('pH-bar').style.width = data.temperature.toFixed(2) + "%";
          // document.getElementById('water-level-bar').style.width = data.temperature.toFixed(2) + "%";
        } catch (e) {
          console.error('Error in sesnor data JSON:', e);
        }
      } catch (e) {
        console.error('Error parsing message JSON:', e);
      }
    };
  </script>
  <script>
      let updatedHum
      updatedHum = Math.round(19.5 * 180 / 100) - 45;

      $("#speedbox-Hum").css("transform", "rotate(" + updatedHum + "deg)");
      let updatedtemp
      updatedtemp = Math.round(32.4 * 180 / 100) - 45;

      $("#speedbox-temp").css("transform", "rotate(" + updatedtemp + "deg)");
      let updatedHum1
      updatedHum1 = Math.round(38 * 180 / 100) - 45;

      $("#speedbox-Hum1").css("transform", "rotate(" + updatedHum1 + "deg)");
      let updatedtemp1
      updatedtemp1 = Math.round(27 * 180 / 100) - 45;

      $("#speedbox-temp1").css("transform", "rotate(" + updatedtemp1 + "deg)");
      // document.getElementById('pH').textContent = data.temperature.toFixed(2);
      // document.getElementById('water-level').textContent = data.humidity.toFixed(2);
      document.getElementById('pH-bar').style.width = (7/14)*100 + "%";
      document.getElementById('water-level-bar').style.width = 73 + "%";
      document.getElementById('pH-bar-static').style.width = (7/14)*100 + "%";
      document.getElementById('water-level-bar-static').style.width = 95 + "%";
  </script>
</body>
<!-- End of the document body -->

</html>
<!-- End of the HTML document -->